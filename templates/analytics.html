{% extends "base.html" %}

{% block title %}Analytics{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<style>
  body {
    background-color: #ffffff;
    color: #000000;
  }
  canvas {
    background: #ffffff;
    border-radius: 8px;
    padding: 8px;
  }
  .card-title {
    font-size: 0.9rem;
    letter-spacing: 1px;
    color: #000000;
  }
  .navbar {
    background-color: #001f3f !important;
  }
</style>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
      <div class="p-3 border bg-light rounded shadow-sm">
        <h5>Filter Panel</h5>
        <form id="filterForm">
          <div class="mb-3">
            <label for="genderFilter" class="form-label">Gender</label>
            <select class="form-select" id="genderFilter">
              <option value="All">All</option>
              <option value="Female">Female</option>
              <option value="Male">Male</option>
              <option value="Both">Both</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="tempFilter" class="form-label">Temperature</label>
            <select class="form-select" id="tempFilter">
              <option value="All">All</option>
              <option value="Cool">Cool</option>
              <option value="Hot">Hot</option>
              <option value="Rainy">Rainy</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="humidityFilter" class="form-label">Humidity</label>
            <select class="form-select" id="humidityFilter">
              <option value="All">All</option>
              <option value="Low">Low</option>
              <option value="Moderate">Moderate</option>
              <option value="High">High</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="ageFilter" class="form-label">Age Group</label>
            <select class="form-select" id="ageFilter">
              <option value="All">All</option>
              <option value="Child">Child</option>
              <option value="Teenager">Teenager</option>
              <option value="Adult">Adult</option>
              <option value="Senior">Senior</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="titleFilter" class="form-label">Ad Title</label>
            <select class="form-select" id="titleFilter">
              <option value="All">All</option>
            </select>
          </div>
          <button class="btn btn-primary w-100" type="submit">Apply Filters</button>
        </form>
      </div>
    </div>
    <!-- Main Dashboard -->
    <div class="col-md-9">
      <h2 class="text-center mt-4 mb-4">Real-Time Analytics Dashboard</h2>
      <div class="row text-dark mb-4">
        <div class="col-md-3 mb-3">
          <div class="card bg-primary shadow text-white">
            <div class="card-body">
              <h6 class="card-title text-uppercase">Total Ads</h6>
              <h3 id="totalAds" class="mb-0">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card bg-success shadow text-white">
            <div class="card-body">
              <h6 class="card-title text-uppercase">Female %</h6>
              <h3 id="femalePercent" class="mb-0">0%</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card bg-warning shadow text-white">
            <div class="card-body">
              <h6 class="card-title text-uppercase">Male %</h6>
              <h3 id="malePercent" class="mb-0">0%</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card bg-info shadow text-white">
            <div class="card-body">
              <h6 class="card-title text-uppercase">Age Groups</h6>
              <h3 id="uniqueAges" class="mb-0">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card shadow text-white" style="background-color: #ff69b4;">
            <div class="card-body">
              <h6 class="card-title text-uppercase">Both %</h6>
              <h3 id="bothPercent" class="mb-0">0%</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card shadow text-white" style="background-color: #8a2be2;">
            <div class="card-body">
              <h6 class="card-title text-uppercase">All %</h6>
              <h3 id="allPercent" class="mb-0">0%</h3>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-6 mb-4">
          <div class="card bg-light text-dark shadow">
            <div class="card-body">
              <h5 class="card-title">Age Group Distribution</h5>
              <canvas id="ageChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-4">
          <div class="card bg-light text-dark shadow">
            <div class="card-body">
              <h5 class="card-title">Gender Breakdown</h5>
              <canvas id="genderChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-4">
          <div class="card bg-light text-dark shadow">
            <div class="card-body">
              <h5 class="card-title">Ads by Temperature</h5>
              <canvas id="tempChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-4">
          <div class="card bg-light text-dark shadow">
            <div class="card-body">
              <h5 class="card-title">Ads by Humidity</h5>
              <canvas id="humidityChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-4">
          <div class="card bg-light text-dark shadow">
            <div class="card-body">
              <h5 class="card-title">Temperature vs Humidity (Scatter Plot)</h5>
              <canvas id="bubbleChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-4">
          <div class="card bg-light text-dark shadow">
            <div class="card-body">
              <h5 class="card-title">Ad Count by Title (Polar Area)</h5>
              <canvas id="radarChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- End col-md-9 -->
  </div> <!-- End row -->
</div> <!-- End container-fluid -->
<script>
  async function loadDashboardData() {
    const gender = document.getElementById("genderFilter")?.value || "All";
    const temperature = document.getElementById("tempFilter")?.value || "All";
    const humidity = document.getElementById("humidityFilter")?.value || "All";
    const age_group = document.getElementById("ageFilter")?.value || "All";
    const title = document.getElementById("titleFilter")?.value || "All";

    const res = await fetch(`/dashboard-data?gender=${gender}&temperature=${temperature}&humidity=${humidity}&age_group=${age_group}&title=${encodeURIComponent(title)}`);
    const data = await res.json();

    const ageGroups = Object.keys(data.age_groups || {});
    const ageCounts = Object.values(data.age_groups || {});
    const genders = Object.keys(data.gender_counts || {});
    const genderCounts = Object.values(data.gender_counts || {});
    const humidityGroups = Object.keys(data.humidity_counts || {});
    const humidityCounts = Object.values(data.humidity_counts || {});
    const temperatureGroups = Object.keys(data.temperature_counts || {});
    const temperatureCounts = Object.values(data.temperature_counts || {});
    const ads = data.ads || [];

    // Update title dropdown dynamically
    const titleSelect = document.getElementById("titleFilter");
    const existingTitles = Array.from(titleSelect.options).map(opt => opt.value);
    const newTitles = [...new Set(ads.map(ad => ad.title))].sort();

    if (existingTitles.length <= 1) {
      newTitles.forEach(title => {
        const option = document.createElement("option");
        option.value = title;
        option.textContent = title;
        titleSelect.appendChild(option);
      });
    }

    const total = genderCounts.reduce((a, b) => a + b, 0);
    const female = data.gender_counts?.Female || 0;
    const male = data.gender_counts?.Male || 0;
    const both = data.gender_counts?.Both || 0;
    const all = data.gender_counts?.All || 0;

    document.getElementById("totalAds").textContent = total;
    document.getElementById("femalePercent").textContent = `${((female / total) * 100 || 0).toFixed(1)}%`;
    document.getElementById("malePercent").textContent = `${((male / total) * 100 || 0).toFixed(1)}%`;
    document.getElementById("bothPercent").textContent = `${((both / total) * 100 || 0).toFixed(1)}%`;
    document.getElementById("allPercent").textContent = `${((all / total) * 100 || 0).toFixed(1)}%`;
    document.getElementById("uniqueAges").textContent = ageGroups.length;
    const clearAndCreate = (id, config) => {
      const old = document.getElementById(id);
      const newCanvas = old.cloneNode();
      old.parentNode.replaceChild(newCanvas, old);

      if (id !== "bubbleChart") {
        config.plugins = config.plugins || [];
        config.plugins.push(ChartDataLabels);
      }

      new Chart(newCanvas, config);
    };

    clearAndCreate("ageChart", {
      type: "pie",
      data: {
        labels: ageGroups,
        datasets: [{
          label: "Age Groups",
          data: ageCounts,
          backgroundColor: ["#f46a6a", "#34c38f", "#f1b44c", "#50a5f1"]
        }]
      }
    });

    clearAndCreate("genderChart", {
      type: "doughnut",
      data: {
        labels: genders,
        datasets: [{
          label: "Genders",
          data: genderCounts,
          backgroundColor: ["#00bcd4", "#e91e63", "#9e9e9e"]
        }]
      }
    });

    clearAndCreate("tempChart", {
      type: "bar",
      data: {
        labels: temperatureGroups,
        datasets: [{
          label: "Number of Ads",
          data: temperatureCounts,
          backgroundColor: temperatureGroups.map((_, i) =>
            ['#ff6384', '#36a2eb', '#ffce56'][i % 3])
        }]
      }
    });

    clearAndCreate("humidityChart", {
      type: "bar",
      data: {
        labels: humidityGroups,
        datasets: [{
          label: "Number of Ads",
          data: humidityCounts,
          backgroundColor: humidityGroups.map((_, i) =>
            ['#8e44ad', '#2ecc71', '#e67e22'][i % 3])
        }]
      }
    });

    const tempMap = { cool: 1, hot: 2, rainy: 3 };
    const humidMap = { low: 1, moderate: 2, high: 3 };
    const uniqueTitles = [...new Set(ads.map(ad => ad.title))];
    const colorMap = Object.fromEntries(uniqueTitles.map((t, i) =>
      [t, `hsl(${(i * 137.5) % 360}, 70%, 60%)`]
    ));

    const scatterPoints = [];
    ads.forEach(ad => {
      const tempRaw = ad.temperature?.toLowerCase().trim();
      const humidRaw = ad.humidity?.toLowerCase().trim();
      const tempVal = tempMap[tempRaw];
      const humidVal = humidMap[humidRaw];
      if (tempVal && humidVal) {
        const jitter = () => (Math.random() - 0.5) * 0.3;
        scatterPoints.push({
          x: tempVal + jitter(),
          y: humidVal + jitter(),
          title: ad.title,
          backgroundColor: colorMap[ad.title]
        });
      }
    });

    clearAndCreate("bubbleChart", {
      type: 'scatter',
      data: {
        datasets: scatterPoints.map(point => ({
          label: point.title,
          data: [{ x: point.x, y: point.y }],
          backgroundColor: point.backgroundColor,
          borderColor: point.backgroundColor,
          pointRadius: 6
        }))
      },
      options: {
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label} at ${ctx.raw.x.toFixed(2)}, ${ctx.raw.y.toFixed(2)}`
            }
          },
          legend: {
            display: true,
            labels: {
              boxWidth: 14,
              font: { size: 10 }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Temperature' },
            ticks: {
              callback: val => Object.keys(tempMap).find(k => tempMap[k] === val) || val
            },
            min: 0,
            max: 4
          },
          y: {
            title: { display: true, text: 'Humidity' },
            ticks: {
              callback: val => Object.keys(humidMap).find(k => humidMap[k] === val) || val
            },
            min: 0,
            max: 4
          }
        }
      }
    });
    const adTitleCounts = {};
    ads.forEach(ad => {
      const title = ad.title?.trim();
      if (!title) return;
      adTitleCounts[title] = (adTitleCounts[title] || 0) + 1;
    });

    const adTitles = Object.keys(adTitleCounts);
    const adCounts = Object.values(adTitleCounts);
    const polarColors = adTitles.map((_, i) => `hsl(${(i * 137.5) % 360}, 70%, 60%)`);

    clearAndCreate("radarChart", {
      type: 'polarArea',
      data: {
        labels: adTitles,
        datasets: [{
          label: "Ad Count by Title",
          data: adCounts,
          backgroundColor: polarColors
        }]
      },
      options: {
        plugins: {
          datalabels: {
            formatter: (value, ctx) => {
              const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              return `${((value / total) * 100).toFixed(1)}%`;
            },
            color: '#fff',
            font: { weight: 'bold', size: 14 }
          },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.label}: ${ctx.formattedValue} ad(s)`
            }
          },
          legend: { position: 'top' }
        },
        scales: {
          r: {
            ticks: { display: false },
            grid: { display: false }
          }
        }
      }
    });
  }

  // Reload data on filter apply
  document.getElementById("filterForm").addEventListener("submit", function (e) {
    e.preventDefault();
    loadDashboardData();
  });

  // Initial chart load
  loadDashboardData();
</script>
{% endblock %}
