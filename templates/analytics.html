{% extends "base.html" %}
{% block title %}Analytics{% endblock %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<style>
  body {
    background-color: #f8f9fc;
    color: #000000;
  }
  canvas {
    background: #ffffff;
    border-radius: 8px;
    padding: 8px;
  }
  .card-title {
    font-size: 0.9rem;
    letter-spacing: 1px;
    color: #000000;
  }
</style>

<div class="container-fluid">

  <!-- ðŸª° Filter Taskbar -->
  <div class="row mb-4">
    <div class="col-12 p-3 bg-white rounded shadow-sm">
      <form id="filterForm" class="row g-2 align-items-end">
        {% for field, label, id, options in [
            ('Gender', 'Gender', 'genderFilter', ['All', 'Female', 'Male', 'Both']),
            ('Temperature', 'Temperature', 'tempFilter', ['All', 'Cool', 'Hot', 'Rainy']),
            ('Humidity', 'Humidity', 'humidityFilter', ['All', 'Low', 'Moderate', 'High']),
        ] %}
        <div class="col-md-2">
          <label for="{{ id }}" class="form-label">{{ label }}</label>
          <select class="form-select" id="{{ id }}">
            {% for opt in options %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        {% endfor %}
        <div class="col-md-1">
          <button class="btn btn-primary w-100" type="submit">Apply</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ðŸ“Š KPI Cards -->
  <div class="row text-dark mb-4">
    {% for title, id, class_name, style in [
      ('Total Ads', 'totalAds', 'bg-primary text-black', ''),
      ('Female %', 'femalePercent', 'bg-success text-black', ''),
      ('Male %', 'malePercent', 'bg-warning text-black', ''),
      ('Both %', 'bothPercent', 'bg-info text-black', ''),
      ('All %', 'allPercent', 'text-black', 'background-color: #8a2be2'),
      ('Avg Duration', 'avgDuration', 'text-black', 'background-color: #ff69b4')
    ] %}
    <div class="col-md-2 mb-3">
      <div class="card {{ class_name }} shadow text-center" style="{{ style }}">
        <div class="card-body">
          <h6 class="card-title text-uppercase">{{ title }}</h6>
          <h3 id="{{ id }}">0</h3>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ðŸ“ˆ Charts -->
  <div id="chartSection" class="row g-4">
    {% for title, cid in [
      ('Age Group Distribution', 'ageChart'),
      ('Gender Breakdown', 'genderChart'),
      ('Ads by Temperature', 'tempChart'),
      ('Ads by Humidity', 'humidityChart'),
      ('Temp vs Humidity (Scatter)', 'bubbleChart'),
      ('Avg Duration by Emotion', 'durationEmotionChart')
    ] %}
    <div class="col chart-col mb-4">
      <div class="card bg-white text-dark shadow">
        <div class="card-body d-flex flex-column justify-content-center align-items-center" style="height: 280px;">
          <h5 class="card-title mb-3">{{ title }}</h5>
          <canvas id="{{ cid }}" style="max-width: 100%; max-height: 100%;"></canvas>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  const chartSection = document.getElementById("chartSection");
  const viewMode = localStorage.getItem("viewMode") || "vertical";
  chartSection.className = viewMode === "horizontal"
    ? "row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"
    : "row";

  document.querySelectorAll(".col.chart-col").forEach(col => {
    if (viewMode === "vertical") col.classList.add("col-lg-6");
  });

  async function loadDashboardData() {
    const params = ['gender', 'temperature', 'humidity', 'age_group']
      .map(f => `${f}=${encodeURIComponent(document.getElementById(f + 'Filter')?.value || 'All')}`)
      .join('&');

    const res = await fetch(`/dashboard-data?${params}`);
    const data = await res.json();

    const clearAndCreate = (id, config) => {
      const old = document.getElementById(id);
      const newCanvas = old.cloneNode();
      old.parentNode.replaceChild(newCanvas, old);
      if (id !== "bubbleChart" && id !== "engagementChart") {
        config.plugins = config.plugins || [];
        config.plugins.push(ChartDataLabels);
      }
      new Chart(newCanvas, config);
    };

    const total = Object.values(data.gender_counts || {}).reduce((a, b) => a + b, 0);
    const getPct = g => ((data.gender_counts?.[g] || 0) / total * 100).toFixed(1);
    document.getElementById("totalAds").textContent = total;
    document.getElementById("femalePercent").textContent = `${getPct("Female")}%`;
    document.getElementById("malePercent").textContent = `${getPct("Male")}%`;
    document.getElementById("bothPercent").textContent = `${getPct("Both")}%`;
    document.getElementById("allPercent").textContent = `${getPct("All")}%`;
    document.getElementById("avgDuration").textContent = data.avg_duration?.toFixed(1) || '0.0';

    clearAndCreate("ageChart", {
      type: "pie",
      data: {
        labels: Object.keys(data.age_groups || {}),
        datasets: [{
          label: "Age Groups",
          data: Object.values(data.age_groups || {}),
          backgroundColor: ["#f46a6a", "#34c38f", "#f1b44c", "#50a5f1"]
        }]
      }
    });

    clearAndCreate("genderChart", {
      type: "doughnut",
      data: {
        labels: Object.keys(data.gender_counts || {}),
        datasets: [{
          label: "Genders",
          data: Object.values(data.gender_counts || {}),
          backgroundColor: ["#00bcd4", "#e91e63", "#9e9e9e"]
        }]
      }
    });

    clearAndCreate("tempChart", {
      type: "bar",
      data: {
        labels: Object.keys(data.temperature_counts || {}),
        datasets: [{
          label: "Number of Ads",
          data: Object.values(data.temperature_counts || {}),
          backgroundColor: ["#ff6384", "#36a2eb", "#ffce56"]
        }]
      }
    });

    clearAndCreate("humidityChart", {
      type: "bar",
      data: {
        labels: Object.keys(data.humidity_counts || {}),
        datasets: [{
          label: "Number of Ads",
          data: Object.values(data.humidity_counts || {}),
          backgroundColor: ["#8e44ad", "#2ecc71", "#e67e22"]
        }]
      }
    });

    clearAndCreate("bubbleChart", {
      type: 'scatter',
      data: {
        datasets: [{
          label: "Temp vs Humidity",
          data: data.scatter || [],
          backgroundColor: "#007bff",
          borderColor: "#007bff",
          pointRadius: 5
        }]
      },
      options: {
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `Temp: ${ctx.raw.x.toFixed(1)}Â°C, Humidity: ${ctx.raw.y.toFixed(1)}%`
            }
          },
          legend: { display: false }
        },
        scales: {
          x: {
            title: { display: true, text: 'Temperature (Â°C)' }
          },
          y: {
            title: { display: true, text: 'Humidity (%)' }
          }
        }
      }
    });

    clearAndCreate("durationEmotionChart", {
      type: "bar",
      data: {
        labels: (data.avg_duration_emotion || []).map(d => d.x),
        datasets: [{
          label: "Average Duration (s)",
          data: (data.avg_duration_emotion || []).map(d => d.y),
          backgroundColor: ["#ff9999", "#66b3ff", "#99ff99"]
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "Duration (seconds)" }
          },
          x: {
            title: { display: true, text: "Emotion" }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  }

  document.getElementById("filterForm").addEventListener("submit", e => {
    e.preventDefault();
    loadDashboardData();
  });

  loadDashboardData();
</script>
{% endblock %}
