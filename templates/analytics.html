{% extends "base.html" %}

{% block title %}Analytics{% endblock %}

{% block content %}
<style>
  body {
    background-color: #ffffff;
    color: #000000;
  }
  canvas {
    background: #ffffff;
    border-radius: 8px;
    padding: 8px;
  }
  .card-title {
    font-size: 0.9rem;
    letter-spacing: 1px;
    color: #000000;
  }
  .navbar {
    background-color: #001f3f !important;
  }
</style>

<h2 class="text-center mb-4">Real-Time Analytics Dashboard</h2>

<div class="row text-dark mb-4">
  <div class="col-md-3 mb-3">
    <div class="card bg-primary shadow text-white">
      <div class="card-body">
        <h6 class="card-title text-uppercase">Total Ads</h6>
        <h3 id="totalAds" class="mb-0">0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card bg-success shadow text-white">
      <div class="card-body">
        <h6 class="card-title text-uppercase">Female %</h6>
        <h3 id="femalePercent" class="mb-0">0%</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card bg-warning shadow text-white">
      <div class="card-body">
        <h6 class="card-title text-uppercase">Male %</h6>
        <h3 id="malePercent" class="mb-0">0%</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card bg-info shadow text-white">
      <div class="card-body">
        <h6 class="card-title text-uppercase">Age Groups</h6>
        <h3 id="uniqueAges" class="mb-0">0</h3>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-6 mb-4">
    <div class="card bg-light text-dark shadow">
      <div class="card-body">
        <h5 class="card-title">Age Group Distribution</h5>
        <canvas id="ageChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6 mb-4">
    <div class="card bg-light text-dark shadow">
      <div class="card-body">
        <h5 class="card-title">Gender Breakdown</h5>
        <canvas id="genderChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6 mb-4">
    <div class="card bg-light text-dark shadow">
      <div class="card-body">
        <h5 class="card-title">Ads by Temperature</h5>
        <canvas id="tempChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6 mb-4">
    <div class="card bg-light text-dark shadow">
      <div class="card-body">
        <h5 class="card-title">Ads by Humidity</h5>
        <canvas id="humidityChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6 mb-4">
    <div class="card bg-light text-dark shadow">
      <div class="card-body">
        <h5 class="card-title">Temperature vs Humidity (Bubble Chart)</h5>
        <canvas id="bubbleChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6 mb-4">
    <div class="card bg-light text-dark shadow">
      <div class="card-body">
        <h5 class="card-title">Ad Count by Gender and Temperature (Radar)</h5>
        <canvas id="radarChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  async function loadDashboardData() {
    const res = await fetch("/dashboard-data");
    const data = await res.json();

    const ageGroups = Object.keys(data.age_groups || {});
    const ageCounts = Object.values(data.age_groups || {});
    const genders = Object.keys(data.gender_counts || {});
    const genderCounts = Object.values(data.gender_counts || {});
    const humidityGroups = Object.keys(data.humidity_counts || {});
    const humidityCounts = Object.values(data.humidity_counts || {});
    const temperatureGroups = Object.keys(data.temperature_counts || {});
    const temperatureCounts = Object.values(data.temperature_counts || {});

    const total = genderCounts.reduce((a, b) => a + b, 0);
    const female = data.gender_counts?.female || 0;
    const male = data.gender_counts?.male || 0;

    document.getElementById("totalAds").textContent = total;
    document.getElementById("femalePercent").textContent = `${((female / total) * 100).toFixed(1)}%`;
    document.getElementById("malePercent").textContent = `${((male / total) * 100).toFixed(1)}%`;
    document.getElementById("uniqueAges").textContent = ageGroups.length;

    new Chart(document.getElementById("ageChart"), {
      type: "pie",
      data: {
        labels: ageGroups,
        datasets: [{ label: "Age Groups", data: ageCounts, backgroundColor: ["#f46a6a", "#34c38f", "#f1b44c", "#50a5f1"] }]
      }
    });

    new Chart(document.getElementById("genderChart"), {
      type: "doughnut",
      data: {
        labels: genders,
        datasets: [{ label: "Genders", data: genderCounts, backgroundColor: ["#00bcd4", "#e91e63", "#9e9e9e"] }]
      }
    });

    new Chart(document.getElementById("tempChart"), {
      type: "bar",
      data: {
        labels: temperatureGroups,
        datasets: [{ label: "Number of Ads", data: temperatureCounts, backgroundColor: "#6f42c1" }]
      }
    });

    new Chart(document.getElementById("humidityChart"), {
      type: "bar",
      data: {
        labels: humidityGroups,
        datasets: [{ label: "Number of Ads", data: humidityCounts, backgroundColor: "#20c997" }]
      }
    });

    // Bubble chart for temperature vs humidity
    const tempMap = { cool: 1, hot: 2, rainy: 3 };
    const humidMap = { low: 1, moderate: 2, high: 3 };
    const bubbles = (data.ads || []).map(ad => {
      const tempVal = tempMap[ad.temperature];
      const humidVal = humidMap[ad.humidity];
      if (tempVal && humidVal) {
        return { x: tempVal, y: humidVal, r: 6, label: ad.title };
      }
    }).filter(Boolean);

    new Chart(document.getElementById("bubbleChart"), {
      type: 'bubble',
      data: {
        datasets: [{
          label: 'Ads',
          data: bubbles,
          backgroundColor: '#ff6384'
        }]
      },
      options: {
        parsing: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.raw.label}`
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Temperature' },
            ticks: {
              callback: val => Object.keys(tempMap).find(k => tempMap[k] === val) || val
            },
            min: 0, max: 4
          },
          y: {
            title: { display: true, text: 'Humidity' },
            ticks: {
              callback: val => Object.keys(humidMap).find(k => humidMap[k] === val) || val
            },
            min: 0, max: 4
          }
        }
      }
    });

    // Radar chart by gender and temperature
    const tempKeys = Object.keys(tempMap);
    const genderTemp = { male: {}, female: {}, both: {}, all: {} };
    (data.ads || []).forEach(ad => {
      const gender = ad.gender || "unknown";
      const temp = ad.temperature || "unknown";
      if (!genderTemp[gender]) genderTemp[gender] = {};
      genderTemp[gender][temp] = (genderTemp[gender][temp] || 0) + 1;
    });

    new Chart(document.getElementById("radarChart"), {
      type: 'radar',
      data: {
        labels: tempKeys,
        datasets: Object.entries(genderTemp).map(([gender, temps], idx) => ({
          label: gender,
          data: tempKeys.map(t => temps[t] || 0),
          fill: true,
          borderColor: `hsl(${idx * 90}, 70%, 50%)`,
          backgroundColor: `hsla(${idx * 90}, 70%, 50%, 0.2)`
        }))
      },
      options: {
        scales: {
          r: {
            beginAtZero: true
          }
        }
      }
    });
  }

  loadDashboardData();
</script>
{% endblock %}
